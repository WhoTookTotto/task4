<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather App</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="navbar">
        <span class="nav-title">My Cool Website</span>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="weather">Weather in Trondheim</a>
            <a href="reverse-proxy-test">Reverse Proxy Test</a>
        </div>
    </div>
    <div class="weather-container card">
        <h1>Weather App</h1>
        Loading weather data...
    </div>
    <script>
        const state = {
            currentWeather: {},
            sunriseTime: {},
            sunsetTime: {},
            hourlyWeatherData: {},
            set(key, value) {
                if (this[key] === value) return;
                this[key] = value;
                render();
            },
            get(key) {
                return this[key];
            }
        }

         function init() {
            fetchWeatherData();
            setInterval(fetchWeatherData, 10000); // Refresh every 10 seconds
        }

        function fetchWeatherData() {
            let weatherData = fetch('https://api.open-meteo.com/v1/forecast?latitude=63.4305&longitude=10.3951&daily=sunrise,sunset&hourly=temperature_2m,rain&current=temperature_2m,wind_speed_10m,wind_direction_10m,wind_gusts_10m,rain,showers,precipitation,snowfall,weather_code&minutely_15=snowfall&timezone=Europe%2FBerlin')
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    state.set('currentWeather', data.current);
                    state.set('sunriseTime', data.daily.sunrise[0]); 
                    state.set('sunsetTime', data.daily.sunset[0]);
                    state.set('hourlyWeatherData', data.hourly);
                })
                .catch(error => console.error('Error fetching weather data:', error));
        }

        function generateWeatherReport() {
            if (!state.get('currentWeather')) {
                return "Weather data is not available.";
            }
            return `The current temperature is ${state.get('currentWeather').temperature_2m}°C with ${rainCodes[state.get('currentWeather').weather_code]}.`;
        }

        function selectWeatherImage(weatherCode, isNight) {
            const weatherImage = document.getElementById('api-image');
            let imageUrl = '';

            // Map weather codes to image URLs
            if ([0, 1, 2, 3].includes(weatherCode)) {
                imageUrl = 'images/trondheim-sunny.jpg'; // Clear sky
            } else if ([45, 48].includes(weatherCode)) {
                imageUrl = 'images/trondheim-tåke.jpg'; // Fog
            } else if ([51, 53, 55, 56, 57, 61, 63, 65, 80, 81, 82].includes(weatherCode)) {
                imageUrl = 'images/trondheim-cloudy.webp'; // Rain
            } else if ([71, 73, 75, 77, 85, 86].includes(weatherCode)) {
                imageUrl = 'images/trondheim-snø.jpg'; // Snow
            } 

            if (isNight) {
                weatherImage.classList.add('night');
            } else {
                weatherImage.classList.remove('night');
            }

            if ([95, 96, 99].includes(weatherCode)) {
                // apply .thunderstorm effect
                weatherImage.classList.add('thunderstorm');
            } else {
                weatherImage.classList.remove('thunderstorm');
            }

            weatherImage.src = imageUrl;
        }

        function render() {

            document.querySelector('.weather-container').innerHTML = `
                <h1>Weather App</h1>
                Page for seeing the current weather in Trondheim.
                <div class="card-section">
                <div class="card-text">${generateWeatherReport()}</div>
                <ul style="margin-bottom:1.5rem; color:#235390;">
                    <li>Sunrise: ${new Date(state.get('sunriseTime')).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</li>
                    <li>Sunset: ${new Date(state.get('sunsetTime')).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</li>
                </ul>
                <div id="weather-image-container">
                    <img id="api-image" class="card-image">
                </div>
                </div>
            `;

            const currentHour = new Date().getHours();
            let sundownHour = new Date(state.get('sunsetTime')).getHours();
            let sunupHour = new Date(state.get('sunriseTime')).getHours();
            selectWeatherImage(state.get('currentWeather').weather_code, currentHour >= sundownHour || currentHour < sunupHour);
        }

        window.onload = init;
        
        // Weather codes from https://www.nodc.noaa.gov/archive/arc0021/0002199/1.1/data/0-data/HTML/WMO-CODE/WMO4677.HTM
        const rainCodes = {
            0: "Cloud development not observed or not observable",
            1: "Clouds generally dissolving or becoming less developed",
            2: "State of sky on the whole unchanged",
            3: "Clouds generally forming or developing",
            4: "Visibility reduced by smoke",
            5: "Haze",
            6: "Widespread dust in suspension in the air",
            7: "Dust or sand raised by wind at or near the station",
            8: "Well developed dust whirl(s) or sand whirl(s) seen",
            9: "Duststorm or sandstorm within sight or at the station",
            10: "Mist",
            11: "Patches of shallow fog or ice fog",
            12: "More or less continuous shallow fog or ice fog",
            13: "Lightning visible, no thunder heard",
            14: "Precipitation within sight, not reaching the ground",
            15: "Precipitation within sight, reaching the ground, distant",
            16: "Precipitation within sight, reaching the ground, near",
            17: "Thunderstorm, but no precipitation",
            18: "Squalls at or within sight of the station",
            19: "Funnel cloud(s)",
            20: "Drizzle or snow grains, not falling as showers",
            21: "Rain (not freezing)",
            22: "Snow",
            23: "Rain and snow or ice pellets",
            24: "Freezing drizzle or freezing rain",
            25: "Showers of rain",
            26: "Showers of snow, or of rain and snow",
            27: "Showers of hail, or of rain and hail",
            28: "Fog or ice fog",
            29: "Thunderstorm (with or without precipitation)",
            30: "Slight or moderate duststorm or sandstorm, decreased",
            31: "Slight or moderate duststorm or sandstorm, no change",
            32: "Slight or moderate duststorm or sandstorm, increased",
            33: "Severe duststorm or sandstorm, decreased",
            34: "Severe duststorm or sandstorm, no change",
            35: "Severe duststorm or sandstorm, increased",
            36: "Slight or moderate blowing snow, low",
            37: "Heavy drifting snow",
            38: "Slight or moderate blowing snow, high",
            39: "Heavy drifting snow",
            40: "Fog or ice fog at a distance, not at station",
            41: "Fog or ice fog in patches",
            42: "Fog or ice fog, sky visible, thinner",
            43: "Fog or ice fog, sky invisible",
            44: "Fog or ice fog, sky visible, no change",
            45: "Fog or ice fog, sky invisible",
            46: "Fog or ice fog, sky visible, thicker",
            47: "Fog or ice fog, sky invisible",
            48: "Fog, depositing rime, sky visible",
            49: "Fog, depositing rime, sky invisible",
            50: "Drizzle, not freezing, intermittent, slight",
            51: "Drizzle, not freezing, continuous, slight",
            52: "Drizzle, not freezing, intermittent, moderate",
            53: "Drizzle, not freezing, continuous, moderate",
            54: "Drizzle, not freezing, intermittent, heavy",
            55: "Drizzle, not freezing, continuous, heavy",
            56: "Drizzle, freezing, slight",
            57: "Drizzle, freezing, moderate or heavy",
            58: "Drizzle and rain, slight",
            59: "Drizzle and rain, moderate or heavy",
            60: "Rain, not freezing, intermittent, slight",
            61: "Rain, not freezing, continuous, slight",
            62: "Rain, not freezing, intermittent, moderate",
            63: "Rain, not freezing, continuous, moderate",
            64: "Rain, not freezing, intermittent, heavy",
            65: "Rain, not freezing, continuous, heavy",
            66: "Rain, freezing, slight",
            67: "Rain, freezing, moderate or heavy",
            68: "Rain or drizzle and snow, slight",
            69: "Rain or drizzle and snow, moderate or heavy",
            70: "Intermittent fall of snowflakes, slight",
            71: "Continuous fall of snowflakes, slight",
            72: "Intermittent fall of snowflakes, moderate",
            73: "Continuous fall of snowflakes, moderate",
            74: "Intermittent fall of snowflakes, heavy",
            75: "Continuous fall of snowflakes, heavy",
            76: "Diamond dust",
            77: "Snow grains",
            78: "Isolated star-like snow crystals",
            79: "Ice pellets",
            80: "Rain showers, slight",
            81: "Rain showers, moderate or heavy",
            82: "Rain showers, violent",
            83: "Showers of rain and snow mixed, slight",
            84: "Showers of rain and snow mixed, moderate or heavy",
            85: "Snow showers, slight",
            86: "Snow showers, moderate or heavy",
            87: "Showers of snow pellets or small hail, slight",
            88: "Showers of snow pellets or small hail, moderate or heavy",
            89: "Showers of hail, slight",
            90: "Showers of hail, moderate or heavy",
            91: "Slight rain, thunderstorm during preceding hour",
            92: "Moderate or heavy rain, thunderstorm during preceding hour",
            93: "Slight snow, or rain and snow mixed or hail at time of observation",
            94: "Moderate or heavy snow, or rain and snow mixed or hail at time of observation",
            95: "Thunderstorm, slight or moderate, without hail but with rain and/or snow",
            96: "Thunderstorm, slight or moderate, with hail",
            97: "Thunderstorm, heavy, without hail but with rain and/or snow",
            98: "Thunderstorm combined with duststorm or sandstorm",
            99: "Thunderstorm, heavy, with hail"
        }
        
    </script>
</body>
</html>